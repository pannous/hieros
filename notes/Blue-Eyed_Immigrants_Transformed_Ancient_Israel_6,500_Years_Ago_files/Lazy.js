define("Purch/Utils/Lazy",["jquery","Purch/Utils/Templating"],function(a,b){"use strict";var c=function(c){c=a.extend({init:!0,elementsAccessor:".lazy",timer:0,offsetY:0,offsetX:0,refreshLoaded:!1,canReloadData:!0,delegateOn:!1,needHorizontal:!1,listener:"scroll",onAppear:function(a){return!0},lazyEventName:"Lazy.injectdata",appearEventName:"appear",callbackType:"callback",timeout:0},c||{});var d=this;return d.oConf=c,d.elements=a(c.elementsAccessor),d.init=function(){"scroll"===c.listener?a(window).on(c.listener,function(){clearTimeout(d.oConf.timer),d.oConf.timer=setTimeout(function(){d.scroll()},10)}):a(window).on(c.listener,d.scroll()),!1!==c.delegateOn&&"function"==typeof a.fn.on?a(c.delegateOn).on(c.appearEventName,c.elementsAccessor,d.retrieveData):a(c.elementsAccessor).on(c.appearEventName,d.retrieveData),d.scroll()},d.refresh=function(){d.elements=a(c.elementsAccessor)},d.refreshUnloaded=function(){d.elements=a(c.elementsAccessor).not(".loaded")},d.scroll=function(){d.oConf.refreshLoaded?d.refresh():d.refreshUnloaded(),d.elements.each(function(b,e){d.isInWindow(e)&&a(e).trigger(c.appearEventName)})},d.isInWindow=function(a){return(d.topOfElementIsInWindow(a)||d.bottomOfElementIsInWindow(a)||d.elementJutsOutOnTopAndBottom(a))&&(!d.oConf.needHorizontal||d.leftOfElementIsInWindow(a)||d.rightOfElementIsInWindow(a)||d.elementJutsOutOnLeftAndRight(a))},d.isInWindowMiddleTop=function(a){return d.isInWindow(a)&&d.getElementY(a)<d.getWindowY()+d.getWindowHeight()/2},d.topOfElementIsInWindow=function(a){var b=d.getElementY(a),c=d.oConf.offsetY,e=d.getWindowY(),f=d.getWindowHeight();return b>=e&&b-c<e+f},d.topOfElementIsInWindowMiddleTop=function(a){var b=d.getElementY(a),c=d.oConf.offsetY,e=d.getWindowY(),f=d.getWindowHeight();return b>=e&&b-c<e+f/2},d.leftOfElementIsInWindow=function(a){var b=d.getElementX(a),c=d.oConf.offsetX,e=d.getWindowX(),f=d.getWindowWidth();return b>=e&&b-c<e+f},d.bottomOfElementIsInWindow=function(a){var b=d.getElementY(a),c=d.getElementHeight(a),e=d.oConf.offsetY,f=d.getWindowY(),g=d.getWindowHeight();return b+c>f&&b+c+e<=f+g},d.rightOfElementIsInWindow=function(a){var b=d.getElementX(a),c=d.getElementWidth(a),e=d.oConf.offsetX,f=d.getWindowX(),g=d.getWindowWidth();return b+c>f&&b+c+e<=f+g},d.elementJutsOutOnLeftAndRight=function(a){var b=d.getElementY(a),c=d.getElementHeight(a),e=d.getWindowY(),f=d.getWindowHeight();return b<e&&b+c>e+f},d.elementJutsOutOnTopAndBottom=function(a){var b=d.getElementX(a),c=d.getElementWidth(a),e=d.getWindowX(),f=d.getWindowWidth();return b<e&&b+c>e+f},d.getWindowY=function(){return a(window).scrollTop()},d.getWindowX=function(){return a(window).scrollLeft()},d.getWindowHeight=function(){return d.getElementHeight(window)},d.getWindowWidth=function(){return d.getElementWidth(window)},d.getElementY=function(b){return a(b).offset().top},d.getElementX=function(b){return a(b).offset().left},d.getElementHeight=function(b){return a(b).height()},d.getElementWidth=function(b){return a(b).width()},d.injectScript=function(b){var c=b.data("src");null!==c&&""!==c&&a.ajax({url:c,dataType:"script",cache:!0,success:function(){d.refreshUnloaded()}})},d.loadImage=function(a){"undefined"!==a.attr("data-srcset")&&a.attr("srcset",a.attr("data-srcset")),"undefined"!==a.attr("data-src")&&a.attr("src",a.attr("data-src"))},d.retrieveData=function(){var b=a(this),e=b.data("src"),f=b.data("dataLoaded")||!1,g=!0,h=parseInt(b.data("timeout")||c.timeout,10);if(b.hasClass("loaded"))return!0;if(d.oConf.refreshLoaded||(b.addClass("loaded"),d.elements=d.elements.not(b)),!1===d.oConf.canReloadData&&!0===f&&(g=!1),"script"===b.data("type"))return d.injectScript(b),!0;if(b.data("type")===c.callbackType)return c.onComplete(b),!0;if(b.is("img")||b.is("source"))return d.loadImage(b),!0;if(null!==e&&""!==e&&void 0!==e&&!0===g){var i={url:e,type:"GET",context:this,dataType:void 0!==b.data("tmpl")?"jsonp"===b.data("type")?"jsonp":"json":"html",success:d.injectData,error:c.onError||d.error,beforeSend:function(){b.addClass("loading"),c.onLoad&&"function"==typeof c.onLoad&&c.onLoad(b)},complete:function(a){b.removeClass("loading"),c.onComplete&&"function"==typeof c.onComplete&&c.onComplete(b)}};"jsonp"===b.data("type")&&(i.cache=!0,i.jsonpCallback="callback_"+function(a){var b=0;if(0===a.length)return b;for(var c=0;c<a.length;c++){b=(b<<5)-b+a.charCodeAt(c),b&=b}return b<0?-1*b:b}(e)),d.doAjax(i,h),b.data("dataLoaded",!0)}return"function"==typeof d.oConf.onAppear&&d.oConf.onAppear(b),!0},d.doAjax=function(b,c){setTimeout(function(){a.ajax(b)},c)},d.injectData=function(e){var f=a(this);c.processData&&"function"==typeof c.processData&&(e=c.processData(e,f));var g=f.data("tmpl");"function"==typeof c.template?g=c.template(f):void 0!==c.template&&(g=c.template),e&&(void 0!==g&&""!==g?f.html(b.render(g,e)):f.html(e)),d.refreshUnloaded(),c.afterSuccess&&"function"==typeof c.afterSuccess&&c.afterSuccess(f,e),f.trigger(c.lazyEventName)},d.error=function(a){if("undefined"!=typeof console&&a.status>200){var b="Lazy: "+a.status+" error";"function"==typeof console.error?console.error(b):"function"==typeof console.log&&console.log(b)}},d.enableElm=function(b){a(b).removeClass("loaded"),d.refreshUnloaded()},d.disableElm=function(b){a(b).addClass("loaded"),d.refreshUnloaded()},c.init&&d.init(),d};return c.initModule=function(a){return new c(a||{})},c});